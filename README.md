# Exploit-development-for-the-Freefloat-FTP-server
## What is FreefloatFTP server
**FreefloatFTP server is file transfer application used for Windows 7, Windows XP, Windows vista …etc. Its vulnerable for buffer overflow attack when a MDK command is followed by a long string.** 

**In this document its demonstrate the conducting a proper buffer overflow attack against this FreefloatFTP server and get a meterpreter shell.** 

### 1.	Preparation
**For this demonstration we need two virtual machines.**

    1.	Kali Linux - attacker/exploit development (VM Ware)
    2.	Windows XP - victim/debugger (VM Ware)
![image](https://user-images.githubusercontent.com/41545476/81735568-dcef9600-94b2-11ea-90c0-4bbe564adb26.png)
 
 
 **In the attacker’s end (Kali Linux) we need following requirements,**

*   Network configuration- Host only (custom specific virtual network)

**In the victim’s end (Windows) followings are the requirements we need,**

*	Network configuration- Host only (custom specific virtual network)

*	OllyDbg (a graphical debugger) http://www.ollydbg.de/odbg110.zip
*	FreeFloat, a vulnerable (but real) FTP server https://www.exploit-db.com/apps/687ef6f72dcbbf5b2506e80a375377fa-freefloatftpserver.zip

**Note: By using Host only network, we can ensure that others can’t interfere to our network and it’s a best practice.**

![image](https://user-images.githubusercontent.com/41545476/81742917-71abc100-94be-11ea-8e18-0dab6f880302.png)

**Ensure that both virtual machines can communicate each other by using simple ping command.**

![image](https://user-images.githubusercontent.com/41545476/81743043-a586e680-94be-11ea-863e-77eb9d416c5c.png)

![image](https://user-images.githubusercontent.com/41545476/81743958-2a263480-94c0-11ea-9025-e78c2da87dc9.png)


**After gathering the requirements, we need to run the OllyDbg in Windows XP virtual machine (VM).**

**OllyDbg is similar to GNU GDB, except that it is a graphical program (a similar program for Linux is EDB -- both are available in Kali Linux).**

                    
![image](https://user-images.githubusercontent.com/41545476/81744167-7cffec00-94c0-11ea-9ed2-a0c65e6f7fcf.png)

**Note that the Assembly instructions are displayed in a slightly different format in OllyDbg.**

**Then through OllyDbg I’m running our FTP server. Just need to go Files and then click open. Find the FTP server which we have already downloaded and open it.**

![image](https://user-images.githubusercontent.com/41545476/81744304-aa4c9a00-94c0-11ea-96a2-12eb7d90e0ec.png)

**In the OllyDbg registers are visible at top right side which EIP is pointing to the FTPServer entry point. From the top left side assembly instructions are provided and stack is visible at the bottom right.**

![image](https://user-images.githubusercontent.com/41545476/81744383-c4867800-94c0-11ea-8338-61ad305b96c9.png)

![image](https://user-images.githubusercontent.com/41545476/81744411-d23bfd80-94c0-11ea-93e5-24db2d4247d4.png)

**When running the FTP server through the OllyDbg, system might ask to allow the server access to the network and we have to unblock it.**

![image](https://user-images.githubusercontent.com/41545476/81744486-e97aeb00-94c0-11ea-9751-0702e1483005.png)

![image](https://user-images.githubusercontent.com/41545476/81744542-fb5c8e00-94c0-11ea-8382-174910573923.png)

### 2.	Manually Test the Vulnerability 

**In here, before going to develop an exploit for the FTP server, I’m testing the vulnerability manually that we are going to exploit in the next phases.**

**Using “netcat”**

*   Netcat <IP-address> <FTP-port>

![image](https://user-images.githubusercontent.com/41545476/81745067-bd139e80-94c1-11ea-8edc-9324fd1550fb.png)

**As a first step I have logged as an anonymous user through port 21. This application will accept any username/password combination when logging in, as it is designed to be simple.**

**Note that FloatFTP has a buffer overflow when a MDK command is followed by a long string.
MDK designed for communication among peripherals in microcontrollers.**

**So now I’m running MDK command with my own input and test.**

 ![image](https://user-images.githubusercontent.com/41545476/81745158-ed5b3d00-94c1-11ea-9ba2-0fc66d3ed721.png)
 
 **I provide long set of A’s as a MDK command and application cannot handle it. That means it cause a buffer overflow.**
 
 ![image](https://user-images.githubusercontent.com/41545476/81745209-0b28a200-94c2-11ea-9cde-ba88831e5e26.png)

**If I go to the victim’s end (Windows XP), I can see the FTP server got crash due the log MKD command. Also we can further confirm this by looking at the error report.**

![image](https://user-images.githubusercontent.com/41545476/81745337-4b882000-94c2-11ea-8dd8-20490d1dc2ff.png)

![image](https://user-images.githubusercontent.com/41545476/81745421-72465680-94c2-11ea-9720-ea4b7cb8e6d5.png)

**In the error report its clearly mentioned that this crash is due to the “offset:41414141” and 41 is the hex value of “A”. This is considering as an “access violation” and OllyDbg pauses the process.**

**Before moving to next phase let’s get a basic idea about some common CPU registers and their usages.**

*	EIP – Register that contains the memory address of the next instruction to be executed by the program. EIP tells the CPU what to do next.
*	ESP – Register pointing to the top of the stack at any time.
*	EBP – Stays consistent throughout a function so that it can be used as a placeholder to keep track of local variables and parameters.
*	EAX – “accumulator” normally used for arithmetic operations.
*	EBX – Base Register.
*	ECX – “counter” normally used to hold a loop index.
*	EDX – Data Register.
*	ESI/EDI – Used by memory transfer instructions.


### 3.	Use Manual Metasploit module

**Instead of using existing Metasploit exploit, in here I’m using a manual exploit module which is developed under Metasploit framework by Z. Cliffe Schreuders. So the credit of this approach should goes to first owner (Z. Cliffe Schreuders).**

**First of all, in the attacker’s end we need to create the exploit directory path under /root/.msf4/modules/exploits/ path.**

**So my exploit path is: /root/.msf4/modules/exploits/windows/ftp/**

![image](https://user-images.githubusercontent.com/41545476/81745683-da953800-94c2-11ea-9225-2c55b260809c.png)

**My exploit name is: FreeFloatMDKoverflow.rb**

![image](https://user-images.githubusercontent.com/41545476/81745743-f567ac80-94c2-11ea-8913-e924c2e01d65.png)

**Now I’m going to develop an exploit step by step. Above mentioned exploit is the initial stage of development.**

**In here what I’m doing is same as the previous I’m making a MKD command which include 1000 of A s and include it in the exploit. Previously I have manually logged into the FTP server, but when it comes to the Metasploit it does the FTP authentication for us. Let’s run our initial exploit through “MSF Console”.**

![image](https://user-images.githubusercontent.com/41545476/81745927-47103700-94c3-11ea-9ff4-aee71c22f2cf.png)

**Simply it gives same result as earlier but with changed EIP.**

![image](https://user-images.githubusercontent.com/41545476/81745991-5db68e00-94c3-11ea-814c-120c4d999377.png)

**In this approach EIP should change to 0x41414141 (AAAA).**

### 3.1	Finding the offset value

**First we will need to find the offset in our buffer to the bytes that overwrite the EIP register value. Just how many A s would it take to overwrite EIP. This part of the exploit is critical, as it will allow us to hijack the flow of execution. We can do this by using the ‘pattern create’ feature.**

**I just need to set the bad value as “pattern_create(1000)” instead of set of A s. Since earlier I send 1000 A s, this time also use 1000.**

![image](https://user-images.githubusercontent.com/41545476/81746182-a0786600-94c3-11ea-9884-a0dee43fdf5f.png)

**This method generates a special pattern that can be used to calculate the offset value. This special pattern sends as a malicious input to the program. The main objective of this special pattern is to calculate the length of the offset before the EIP overwrite occurs. Because whatever the payload that we are going to send must execute before the EIP overwrite occurs.**

**Before launch my exploit, I need to restart the FTP server in OllyDbg on the victim’s (Windows XP) VM and restart msfconsole on attacker’s (Kali) VM.**

**When I run this exploit, again it caused to the crash of FTP server and return a special EIP address error.**

![image](https://user-images.githubusercontent.com/41545476/81746245-c1d95200-94c3-11ea-9499-fe6fc66bd567.png)

**Simply copy that value (EIP value) run through the msf pattern_offset tool and find the matching offset value. Firstly, I need to go /usr/share/Metasploit-framework/tools directory and give a command “msf-pattern_offset –q <EIP address>”.**
    
**![image](https://user-images.githubusercontent.com/41545476/81746296-db7a9980-94c3-11ea-8658-d2f525941eae.png)**

**In my case EIP offset is 247. So now I know the offset: the number of bytes from the start of the input, to the part of the input that overwrites EIP.**

**This can confirm by our own self. Update bad variable in the exploit code as following.**

![image](https://user-images.githubusercontent.com/41545476/81746447-1f6d9e80-94c4-11ea-9dc8-f544f5bb02d6.png)

**It means 247 A s, four B s and 500 C s.**

**Restart the FTP server on Windows XP and just launch the exploit using Metasploit.**

**If the exploit work correctly, the EIP value that exactly I’m getting is 0x42424242. 42 is the hex value of letter B.**

![image](https://user-images.githubusercontent.com/41545476/81746587-6491d080-94c4-11ea-996b-299a52375b43.png)

### 4.	Adding payload

**Now what I can do is, control execution of the vulnerable service and what I have to do is decide where to put the payload. There are two places that I can place my payload. First one is before the set of B s and other one is after the set of B s. Because now I can control both areas of inputs.**

### 4.1	Browse the Register and Stack panes  

**Browsing the register and panes of OllyDbg I can find the A s, B s and C s.**
 
![image](https://user-images.githubusercontent.com/41545476/81747195-47113680-94c5-11ea-939f-ef4f8acc77fa.png)

![image](https://user-images.githubusercontent.com/41545476/81747421-b7b85300-94c5-11ea-9307-7d69d034c795.png)

**Now we need a new return address to replace “BBBB” which will land me in my shellcode. Since I don’t know exactly where the pointer will land within the C s, I can add NOP slid. Using NOP we can ensure that it definitely gets hit and we are good to go.**

**\x90 * 30 is the NOP**

**NOP means (no-operation) instructions meant to "slide" the CPU's instruction execution flow to its final, desired destination whenever the program branches to a memory address anywhere on the slide.**

**Since the memory addresses change each time the program runs, we cannot write a memory address directly into specific space. To overcome this we can point EIP at an instruction within memory that jumps the code to the ESP register.**

### 5.	Find an instruction

1.	Restart the FTP server on OllyDbg
2.	Right click the instruction pane (top left), and Search for → Command.
3.	Search for “JMP ESP”
In our case it doesn’t exist in the main program. So I need to search through the shared libraries that the program uses for JMP ESP instruction
4.	View (menu) → Executable Modules
When developing an exploit, it’s a best practice to use return values that point to libraries that came with the program. If I used system libraries, they may change each Windows update release.
5.	Select a module 
6.	Search for “JMP ESP”
7.	Once we have found one, copy that address.

![image](https://user-images.githubusercontent.com/41545476/81747923-9a37b900-94c6-11ea-9eb8-80c5a5cf2476.png)

![image](https://user-images.githubusercontent.com/41545476/81747963-ab80c580-94c6-11ea-9e9a-e505357d4d82.png)











